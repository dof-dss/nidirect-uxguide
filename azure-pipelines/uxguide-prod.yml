trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - script: |
      echo "Listing repository root contents:"
      ls -la

      # Sanity check: ensure index.html exists in the chosen source folder
      SOURCE_FOLDER="."
      if [ ! -f "$SOURCE_FOLDER/index.html" ]; then
        echo "❌ index.html not found in $SOURCE_FOLDER. Please ensure your static site files are in the repo root or update SOURCE_FOLDER."
        exit 1
      fi
    displayName: 'Sanity check: verify static site files exist'

  - task: AzureCLI@2
    displayName: 'Upload static site to Azure Storage ($web)'
    inputs:
      azureSubscription: 'EDD-General-Prod'   # Service connection
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -euo pipefail

        STORAGE_ACCOUNT_NAME="uxguide2"
        SOURCE_FOLDER="."     # deploying from repo root

        echo "Enabling static website (idempotent)..."
        az storage blob service-properties update \
          --account-name "$STORAGE_ACCOUNT_NAME" \
          --static-website \
          --index-document index.html \
          --404-document 404.html

        echo "Uploading contents of '$SOURCE_FOLDER' to \$web (overwrite enabled)..."
        # Exclude common files you don't want to publish
        az storage blob upload-batch \
          --account-name "$STORAGE_ACCOUNT_NAME" \
          --destination '$web' \
          --source "$SOURCE_FOLDER" \
          --overwrite true \
          --exclude-pattern ".git/* .github/* node_modules/* **/*.md **/*.MD .azure-pipelines/* .devcontainer/* .vscode/* package*.json *.yml *.yaml *.config .*"

        echo "✅ Deployment complete."
``